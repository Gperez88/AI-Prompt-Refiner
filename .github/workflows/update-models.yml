name: Update Supported Models

on:
  # Run weekly on Sundays at 00:00 UTC
  schedule:
    - cron: '0 0 * * 0'
  
  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:
    inputs:
      providers:
        description: 'Providers to update (comma-separated, or "all")'
        required: false
        default: 'all'
        type: string

jobs:
  update-models:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Compile TypeScript
      run: npm run compile
    
    - name: Update models from APIs
      run: |
        if [ "${{ github.event.inputs.providers }}" = "all" ] || [ -z "${{ github.event.inputs.providers }}" ]; then
          echo "Updating all providers..."
          node dist/scripts/update-models.js --all
        else
          echo "Updating providers: ${{ github.event.inputs.providers }}"
          node dist/scripts/update-models.js --providers ${{ github.event.inputs.providers }}
        fi
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GH_MODELS_TOKEN }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
    
    - name: Check for changes
      id: git-check
      run: |
        git diff --exit-code config/supported-models.json || echo "changed=true" >> $GITHUB_OUTPUT
    
    - name: Bump version and create tag
      if: steps.git-check.outputs.changed == 'true'
      id: version-bump
      run: |
        # Get current version from package.json
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        echo "Current version: $CURRENT_VERSION"
        
        # Split version into parts
        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
        
        # Increment patch version
        NEW_PATCH=$((PATCH + 1))
        NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
        
        echo "New version: $NEW_VERSION"
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        
        # Update package.json
        npm version $NEW_VERSION --no-git-tag-version --allow-same-version
        
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Stage changes
        git add package.json package-lock.json config/supported-models.json
        git commit -m "chore: update supported models and bump version to $NEW_VERSION"
        
        # Create tag
        git tag -a "v$NEW_VERSION" -m "Version $NEW_VERSION - Updated supported AI models"
        
        # Push tag
        git push origin "v$NEW_VERSION"
        
        echo "‚úÖ Created tag v$NEW_VERSION"
    
    - name: Create Pull Request
      if: steps.git-check.outputs.changed == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: update supported models from APIs'
        title: 'chore: Update supported AI models (v${{ steps.version-bump.outputs.new_version }})'
        body: |
          ## ü§ñ Automated Model Update
          
          This PR updates the list of supported AI models based on the latest API responses.
          
          ### Version
          **v${{ steps.version-bump.outputs.new_version }}** (patch release)
          
          ### Changes:
          - Synced model lists from provider APIs
          - Updated verification status based on API responses
          - Updated last checked timestamp
          - Bumped version from previous release
          
          ### Tag Created
          üè∑Ô∏è Tag `v${{ steps.version-bump.outputs.new_version }}` has been automatically created.
          
          ### Providers Checked:
          - [x] OpenAI
          - [x] GitHub Marketplace
          - [x] Google Gemini
          - [x] Groq
          
          > **Note:** This is an automated PR created by GitHub Actions.
          > Please review the changes before merging. The tag has already been created.
        branch: chore/update-models-v${{ steps.version-bump.outputs.new_version }}
        delete-branch: true
        labels: |
          automated
          dependencies
          patch
    
    - name: Notify on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: '‚ö†Ô∏è Model Update Failed',
            body: `The automated model update workflow failed on ${new Date().toISOString()}.\n\nPlease check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}).`,
            labels: ['bug', 'automated', 'ci-cd']
          });
